- name: Deploying a new application version
  hosts: localhost
  connection: local
  gather_facts: no

  tasks:
  - block:
    - name: Deploying a sanity pod
      shell: |
        kubectl apply -f sanity.yml

    - name: Wait for port 8080 to become open
      wait_for:
        host: abutsko-sanity.abutsko.svc.cluster.local
        port: 8080
        delay: 10
        timeout: 80

    - name: Get old page
      uri:
        url: http://abutsko-helloworld.abutsko.svc.cluster.local:8080/helloworld-ws
        status_code: 200
        return_content: yes
      register: old_helloworld

    - name: Get new page
      uri:
        url: http://abutsko-sanity.abutsko.svc.cluster.local:8080/helloworld-ws
        status_code: 200
        return_content: yes
      register: new_helloworld
      #register: helloworld
      #failed_when: "'PLACE_FOR_GIT_HASH' not in helloworld.content"
    - name: Testing new content
      fail:
        msg: It is the same content.
      failed_when: "{{ new_helloworld }}" == "{{ old_helloworld }}"
    always:
    - name: Undeploying a sanity pod
      shell: |
        kubectl delete -f sanity.yml

  - name: Deploying a new deployment
    shell: |
      kubectl apply -f "{{ item }}"
    with_items:
    - deployment.yml
    - service.yml
    - ingress.yml
